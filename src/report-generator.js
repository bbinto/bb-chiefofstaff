import fs from 'fs';
import path from 'path';

/**
 * Report Generator
 * Generates formatted reports from agent outputs
 */
export class ReportGenerator {
  constructor() {
    this.reportDir = path.join(process.cwd(), 'reports');
    this.ensureReportDir();
  }

  /**
   * Ensure reports directory exists
   */
  ensureReportDir() {
    if (!fs.existsSync(this.reportDir)) {
      fs.mkdirSync(this.reportDir, { recursive: true });
    }
  }

  /**
   * Generate a comprehensive report from all agent outputs
   */
  async generateReport(agentResults) {
    const timestamp = new Date();
    const dateStr = timestamp.toISOString().split('T')[0];
    const timeStr = timestamp.toTimeString().split(' ')[0].replace(/:/g, '-');

    let report = this.buildReportHeader(timestamp);

    // Add each agent's output
    for (const result of agentResults) {
      report += this.buildAgentSection(result);
    }

    report += this.buildReportFooter();

    // Save report as markdown
    console.log('[ReportGenerator] Generating Markdown...');
    return this.saveAsMarkdown(report, dateStr, timeStr);
  }

  /**
   * Save report as Markdown
   */
  saveAsMarkdown(report, dateStr, timeStr) {
    const filename = `weekly-report-${dateStr}-${timeStr}.md`;
    const filepath = path.join(this.reportDir, filename);
    fs.writeFileSync(filepath, report, 'utf8');
    console.log(`\nReport saved to: ${filepath}`);
    return filepath;
  }

  /**
   * Build report header
   */
  buildReportHeader(timestamp) {
    return `# Chief of Staff Weekly Report
**Generated**: ${timestamp.toLocaleString()}

---

`;
  }

  /**
   * Build section for an agent's output
   */
  buildAgentSection(result) {
    const title = this.formatAgentName(result.agentName);

    if (!result.success) {
      return `## ${title}

**Status**: Failed
**Error**: ${result.error}

---

`;
    }

    return `## ${title}

${result.output}

${result.usage ? `**Token Usage**: ${result.usage.input_tokens} input, ${result.usage.output_tokens} output\n` : ''}

---

`;
  }

  /**
   * Build report footer
   */
  buildReportFooter() {
    return `
---

*Report generated by Barbara's Chief of Staff Agent System*
*Powered by Claude and Cursor AI*
`;
  }

  /**
   * Format agent name for display
   */
  formatAgentName(agentName) {
    return agentName
      .split('-')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  /**
   * Generate summary report (text only, no file)
   */
  generateSummary(agentResults) {
    let summary = `\n${'='.repeat(80)}\n`;
    summary += `EXECUTION SUMMARY\n`;
    summary += `${'='.repeat(80)}\n\n`;

    const successful = agentResults.filter(r => r.success).length;
    const failed = agentResults.filter(r => !r.success).length;

    summary += `Total Agents Run: ${agentResults.length}\n`;
    summary += `Successful: ${successful}\n`;
    summary += `Failed: ${failed}\n\n`;

    if (failed > 0) {
      summary += `Failed Agents:\n`;
      agentResults
        .filter(r => !r.success)
        .forEach(r => {
          summary += `  - ${r.agentName}: ${r.error}\n`;
        });
    }

    return summary;
  }
}
